<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katakana Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom */
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-slate-200 shadow-sm z-10 shrink-0">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.showHome()">
                <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center text-white font-bold jp-font text-lg">カ</div>
                <h1 class="font-bold text-xl tracking-tight text-slate-900">Katakana<span class="text-red-600">Master</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="score-display" class="hidden text-sm font-semibold bg-slate-100 px-3 py-1 rounded-full text-slate-600">
                    Streak: <span id="streak-value" class="text-red-600">0</span>
                </div>
                <button onclick="app.showHome()" class="p-2 hover:bg-slate-100 rounded-full transition-colors" title="Home">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main id="app-container" class="flex-1 relative overflow-hidden flex flex-col items-center justify-center p-4">
        
        <!-- HOME SCREEN -->
        <div id="home-screen" class="w-full max-w-4xl mx-auto fade-in overflow-y-auto h-full py-8">
            <div class="text-center mb-10">
                <h2 class="text-3xl md:text-4xl font-black text-slate-900 mb-3">Master Japanese Katakana</h2>
                <p class="text-slate-500 text-lg">Choose a training mode to begin your journey.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 px-4">
                <!-- Mode: Type -->
                <button onclick="app.startMode('type')" class="group relative bg-white p-8 rounded-2xl border-2 border-slate-100 shadow-sm hover:border-red-500 hover:shadow-md transition-all text-left">
                    <div class="w-12 h-12 bg-red-50 text-red-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Input Practice</h3>
                    <p class="text-slate-500 text-sm">See the character, type the Romaji. Test your reading speed.</p>
                </button>

                <!-- Mode: Draw -->
                <button onclick="app.startMode('draw')" class="group relative bg-white p-8 rounded-2xl border-2 border-slate-100 shadow-sm hover:border-blue-500 hover:shadow-md transition-all text-left">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Drawing Practice</h3>
                    <p class="text-slate-500 text-sm">See the Romaji, draw the character. Includes stroke overlay check.</p>
                </button>

                <!-- Mode: Quiz -->
                <button onclick="app.startMode('quiz')" class="group relative bg-white p-8 rounded-2xl border-2 border-slate-100 shadow-sm hover:border-green-500 hover:shadow-md transition-all text-left">
                    <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Rapid Quiz</h3>
                    <p class="text-slate-500 text-sm">Multiple choice. Fast-paced recognition training.</p>
                </button>

                <!-- Mode: Chart -->
                <button onclick="app.showChart()" class="group relative bg-white p-8 rounded-2xl border-2 border-slate-100 shadow-sm hover:border-purple-500 hover:shadow-md transition-all text-left">
                    <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Reference Chart</h3>
                    <p class="text-slate-500 text-sm">View all 46 basic Katakana characters in a grid.</p>
                </button>
            </div>
        </div>

        <!-- GAME: TYPE MODE -->
        <div id="type-mode" class="hidden w-full max-w-md mx-auto fade-in flex-col items-center">
            <div class="bg-white rounded-3xl shadow-lg p-10 w-full text-center border border-slate-100">
                <div class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-6">Type the Romaji</div>
                <!-- Changed font-black to font-normal for thinner look -->
                <div id="type-char-display" class="text-9xl font-normal text-slate-800 mb-8 jp-font leading-none">?</div>
                
                <input type="text" id="type-input" 
                    class="w-full text-center text-3xl font-bold py-4 border-b-4 border-slate-200 focus:border-red-500 outline-none bg-transparent transition-colors placeholder-slate-200 text-slate-700"
                    placeholder="romaji" autocomplete="off" autocapitalize="off">
                
                <div id="type-feedback" class="h-6 mt-4 text-sm font-semibold"></div>
            </div>
            <div class="mt-6 flex gap-2">
                <button onclick="app.skipCard()" class="px-6 py-2 bg-slate-200 text-slate-600 font-semibold rounded-lg hover:bg-slate-300 transition-colors">Skip</button>
            </div>
        </div>

        <!-- GAME: DRAW MODE -->
        <div id="draw-mode" class="hidden w-full max-w-lg mx-auto fade-in flex-col items-center">
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden w-full border border-slate-100">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-slate-500 font-medium">Draw: <span id="draw-prompt" class="text-slate-900 font-bold text-2xl ml-2">?</span></span>
                    <button onclick="app.clearCanvas()" class="text-xs font-semibold bg-white border border-slate-200 px-3 py-1.5 rounded-md text-slate-600 hover:bg-slate-50">Clear</button>
                </div>
                
                <div class="relative w-full aspect-square bg-white cursor-crosshair">
                    <!-- Guide Character (Hidden initially) -->
                    <!-- Changed font-black to font-normal for thinner look -->
                    <div id="draw-overlay" class="absolute inset-0 flex items-center justify-center text-[200px] text-red-500/30 font-normal jp-font pointer-events-none opacity-0 transition-opacity duration-300 select-none">
                        ?
                    </div>
                    <canvas id="drawing-canvas" class="w-full h-full touch-none"></canvas>
                </div>

                <div class="p-6 bg-slate-50 border-t border-slate-100 flex flex-col gap-4">
                    <button id="btn-reveal" onclick="app.revealDrawing()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 transition-transform active:scale-95">
                        Reveal & Check
                    </button>

                    <div id="draw-actions" class="hidden grid-cols-2 gap-4">
                        <button onclick="app.gradeDrawing(false)" class="py-3 bg-red-100 text-red-700 font-bold rounded-xl hover:bg-red-200">
                            I was wrong
                        </button>
                        <button onclick="app.gradeDrawing(true)" class="py-3 bg-green-100 text-green-700 font-bold rounded-xl hover:bg-green-200">
                            I got it!
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME: QUIZ MODE -->
        <div id="quiz-mode" class="hidden w-full max-w-lg mx-auto fade-in flex-col items-center">
            <div class="bg-white rounded-3xl shadow-lg p-8 w-full text-center border border-slate-100 mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-slate-100">
                    <div id="quiz-timer" class="h-full bg-red-500 w-full transition-all duration-1000 ease-linear"></div>
                </div>
                <div class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-4 mt-2">Identify the Character</div>
                <!-- Changed font-black to font-normal for thinner look -->
                <div id="quiz-question" class="text-8xl font-normal text-slate-800 jp-font leading-none py-6">?</div>
            </div>

            <div id="quiz-options" class="grid grid-cols-2 gap-4 w-full">
                <!-- Buttons injected via JS -->
            </div>
        </div>

        <!-- CHART SCREEN -->
        <div id="chart-screen" class="hidden w-full max-w-5xl mx-auto fade-in h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 px-4">
                <h2 class="text-2xl font-bold text-slate-800">Katakana Chart</h2>
            </div>
            <div class="flex-1 overflow-y-auto bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                <div id="chart-grid" class="grid grid-cols-5 gap-2 sm:gap-4">
                    <!-- Chart injected via JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-50 py-4 text-center text-slate-400 text-sm border-t border-slate-200 shrink-0">
        <p>Keep practicing every day!</p>
    </footer>

    <script>
        // --- DATA ---
        const KATAKANA_DATA = [
            { char: 'ア', romaji: 'a' }, { char: 'イ', romaji: 'i' }, { char: 'ウ', romaji: 'u' }, { char: 'エ', romaji: 'e' }, { char: 'オ', romaji: 'o' },
            { char: 'カ', romaji: 'ka' }, { char: 'キ', romaji: 'ki' }, { char: 'ク', romaji: 'ku' }, { char: 'ケ', romaji: 'ke' }, { char: 'コ', romaji: 'ko' },
            { char: 'サ', romaji: 'sa' }, { char: 'シ', romaji: 'shi' }, { char: 'ス', romaji: 'su' }, { char: 'セ', romaji: 'se' }, { char: 'ソ', romaji: 'so' },
            { char: 'タ', romaji: 'ta' }, { char: 'チ', romaji: 'chi' }, { char: 'ツ', romaji: 'tsu' }, { char: 'テ', romaji: 'te' }, { char: 'ト', romaji: 'to' },
            { char: 'ナ', romaji: 'na' }, { char: 'ニ', romaji: 'ni' }, { char: 'ヌ', romaji: 'nu' }, { char: 'ネ', romaji: 'ne' }, { char: 'ノ', romaji: 'no' },
            { char: 'ハ', romaji: 'ha' }, { char: 'ヒ', romaji: 'hi' }, { char: 'フ', romaji: 'fu' }, { char: 'ヘ', romaji: 'he' }, { char: 'ホ', romaji: 'ho' },
            { char: 'マ', romaji: 'ma' }, { char: 'ミ', romaji: 'mi' }, { char: 'ム', romaji: 'mu' }, { char: 'メ', romaji: 'me' }, { char: 'モ', romaji: 'mo' },
            { char: 'ヤ', romaji: 'ya' }, { char: 'ユ', romaji: 'yu' }, { char: 'ヨ', romaji: 'yo' },
            { char: 'ラ', romaji: 'ra' }, { char: 'リ', romaji: 'ri' }, { char: 'ル', romaji: 'ru' }, { char: 'レ', romaji: 're' }, { char: 'ロ', romaji: 'ro' },
            { char: 'ワ', romaji: 'wa' }, { char: 'ヲ', romaji: 'wo' }, { char: 'ン', romaji: 'n' }
        ];

        // --- APPLICATION STATE ---
        const app = {
            mode: 'home',
            currentCard: null,
            streak: 0,
            canvasContext: null,
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            // For draw mode: track shown cards to avoid repetition
            drawModeCards: [],
            drawModeIndex: 0,
            // For type mode: track shown cards to avoid repetition
            typeModeCards: [],
            typeModeIndex: 0,

            // Initialize
            init: function() {
                this.cacheDOM();
                this.bindEvents();
                this.renderChart();
                // Initialize draw mode cards
                this.initializeDrawModeCards();
                // Initialize type mode cards
                this.initializeTypeModeCards();
            },

            cacheDOM: function() {
                this.dom = {
                    screens: {
                        home: document.getElementById('home-screen'),
                        type: document.getElementById('type-mode'),
                        draw: document.getElementById('draw-mode'),
                        quiz: document.getElementById('quiz-mode'),
                        chart: document.getElementById('chart-screen')
                    },
                    navScore: document.getElementById('score-display'),
                    streakVal: document.getElementById('streak-value'),
                    // Type Mode
                    typeChar: document.getElementById('type-char-display'),
                    typeInput: document.getElementById('type-input'),
                    typeFeedback: document.getElementById('type-feedback'),
                    // Draw Mode
                    canvas: document.getElementById('drawing-canvas'),
                    drawPrompt: document.getElementById('draw-prompt'),
                    drawOverlay: document.getElementById('draw-overlay'),
                    btnReveal: document.getElementById('btn-reveal'),
                    drawActions: document.getElementById('draw-actions'),
                    // Quiz Mode
                    quizQuestion: document.getElementById('quiz-question'),
                    quizOptions: document.getElementById('quiz-options'),
                    // Chart
                    chartGrid: document.getElementById('chart-grid')
                };
                
                // Canvas setup
                this.canvasContext = this.dom.canvas.getContext('2d');
            },

            bindEvents: function() {
                // Type Mode Input
                this.dom.typeInput.addEventListener('input', (e) => this.handleTypeInput(e));
                this.dom.typeInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.checkTypeAnswer();
                });

                // Canvas Events
                const c = this.dom.canvas;
                c.addEventListener('mousedown', (e) => this.startDrawing(e));
                c.addEventListener('mousemove', (e) => this.draw(e));
                c.addEventListener('mouseup', () => this.stopDrawing());
                c.addEventListener('mouseout', () => this.stopDrawing());
                
                c.addEventListener('touchstart', (e) => this.startDrawing(e), { passive: false });
                c.addEventListener('touchmove', (e) => this.draw(e), { passive: false });
                c.addEventListener('touchend', () => this.stopDrawing());
                
                // Resize Observer for Canvas
                new ResizeObserver(() => this.resizeCanvas()).observe(c.parentElement);
            },

            // --- NAVIGATION ---
            showHome: function() {
                this.switchScreen('home');
                this.dom.navScore.classList.add('hidden');
                this.streak = 0;
                this.updateStreak();
            },

            startMode: function(modeName) {
                this.mode = modeName;
                this.streak = 0;
                this.updateStreak();
                this.dom.navScore.classList.remove('hidden');
                this.switchScreen(modeName);

                if (modeName === 'type') {
                    // Reinitialize type mode cards for a fresh sequence
                    this.initializeTypeModeCards();
                    this.nextTypeCard();
                }
                if (modeName === 'draw') {
                    this.resizeCanvas();
                    // Reinitialize draw mode cards for a fresh sequence
                    this.initializeDrawModeCards();
                    this.nextDrawCard();
                }
                if (modeName === 'quiz') this.nextQuizCard();
            },

            showChart: function() {
                this.switchScreen('chart');
            },

            switchScreen: function(screenName) {
                Object.values(this.dom.screens).forEach(el => el.classList.add('hidden'));
                this.dom.screens[screenName].classList.remove('hidden');
            },

            getRandomCard: function() {
                return KATAKANA_DATA[Math.floor(Math.random() * KATAKANA_DATA.length)];
            },

            // Get next card for draw mode (non-repeating)
            getNextDrawCard: function() {
                // If we've shown all cards or haven't initialized the array, reshuffle
                if (this.drawModeIndex >= this.drawModeCards.length) {
                    this.initializeDrawModeCards();
                }
                
                // Get the next card in the shuffled sequence
                const card = this.drawModeCards[this.drawModeIndex];
                this.drawModeIndex++;
                return card;
            },

            // Initialize and shuffle the draw mode cards
            initializeDrawModeCards: function() {
                // Create a copy of the katakana data
                this.drawModeCards = [...KATAKANA_DATA];
                
                // Shuffle the array using Fisher-Yates algorithm
                for (let i = this.drawModeCards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.drawModeCards[i], this.drawModeCards[j]] = [this.drawModeCards[j], this.drawModeCards[i]];
                }
                
                // Reset index
                this.drawModeIndex = 0;
            },

            // Get next card for type mode (non-repeating)
            getNextTypeCard: function() {
                // If we've shown all cards or haven't initialized the array, reshuffle
                if (this.typeModeIndex >= this.typeModeCards.length) {
                    this.initializeTypeModeCards();
                }
                
                // Get the next card in the shuffled sequence
                const card = this.typeModeCards[this.typeModeIndex];
                this.typeModeIndex++;
                return card;
            },

            // Initialize and shuffle the type mode cards
            initializeTypeModeCards: function() {
                // Create a copy of the katakana data
                this.typeModeCards = [...KATAKANA_DATA];
                
                // Shuffle the array using Fisher-Yates algorithm
                for (let i = this.typeModeCards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.typeModeCards[i], this.typeModeCards[j]] = [this.typeModeCards[j], this.typeModeCards[i]];
                }
                
                // Reset index
                this.typeModeIndex = 0;
            },

            updateStreak: function(reset = false) {
                if (reset) this.streak = 0;
                this.dom.streakVal.textContent = this.streak;
            },

            // --- TYPE MODE ---
            nextTypeCard: function() {
                this.currentCard = this.getNextTypeCard();
                this.dom.typeChar.textContent = this.currentCard.char;
                this.dom.typeInput.value = '';
                this.dom.typeInput.focus();
                this.dom.typeFeedback.textContent = '';
                this.dom.typeChar.classList.remove('text-green-500', 'text-red-500', 'shake');
            },

            handleTypeInput: function(e) {
                // Auto-check on match (optional, but snappy)
                const val = e.target.value.toLowerCase().trim();
                if (val === this.currentCard.romaji) {
                    this.checkTypeAnswer();
                }
            },

            checkTypeAnswer: function() {
                const val = this.dom.typeInput.value.toLowerCase().trim();
                if (val === this.currentCard.romaji) {
                    // Correct
                    this.dom.typeChar.classList.add('text-green-500');
                    this.streak++;
                    this.updateStreak();
                    setTimeout(() => this.nextTypeCard(), 400);
                } else {
                    // Wrong
                    this.dom.typeChar.classList.add('text-red-500', 'shake');
                    this.dom.typeFeedback.textContent = `Correct: ${this.currentCard.romaji}`;
                    this.dom.typeFeedback.classList.add('text-red-500');
                    this.streak = 0;
                    this.updateStreak();
                    setTimeout(() => this.dom.typeChar.classList.remove('shake'), 500);
                }
            },

            skipCard: function() {
                this.streak = 0;
                this.updateStreak();
                this.nextTypeCard();
            },

            // --- DRAW MODE ---
            resizeCanvas: function() {
                const rect = this.dom.canvas.parentElement.getBoundingClientRect();
                this.dom.canvas.width = rect.width;
                this.dom.canvas.height = rect.height;
                // Set line styles after resize
                this.canvasContext.lineJoin = 'round';
                this.canvasContext.lineCap = 'round';
                this.canvasContext.lineWidth = 12;
                this.canvasContext.strokeStyle = '#1e293b'; // slate-800
            },

            nextDrawCard: function() {
                this.currentCard = this.getNextDrawCard();
                
                // FIX: Instantly hide overlay to prevent flashing the new answer
                // 1. Remove transition classes temporarily
                this.dom.drawOverlay.classList.remove('transition-opacity', 'duration-300');
                // 2. Force opacity to 0 instantly
                this.dom.drawOverlay.classList.remove('opacity-100');
                this.dom.drawOverlay.classList.add('opacity-0');
                
                // 3. Force browser to apply style change immediately (reflow)
                void this.dom.drawOverlay.offsetWidth;
                
                // 4. Now update text (user won't see it because opacity is 0)
                this.dom.drawPrompt.textContent = this.currentCard.romaji;
                this.dom.drawOverlay.textContent = this.currentCard.char;
                
                // 5. Add transition back for the NEXT reveal
                setTimeout(() => {
                    this.dom.drawOverlay.classList.add('transition-opacity', 'duration-300');
                }, 50);

                this.clearCanvas();
                
                this.dom.btnReveal.classList.remove('hidden');
                this.dom.drawActions.classList.add('hidden');
                this.dom.drawActions.classList.remove('grid');
            },

            clearCanvas: function() {
                this.canvasContext.clearRect(0, 0, this.dom.canvas.width, this.dom.canvas.height);
            },

            startDrawing: function(e) {
                this.isDrawing = true;
                const pos = this.getPos(e);
                this.lastX = pos.x;
                this.lastY = pos.y;
            },

            draw: function(e) {
                if (!this.isDrawing) return;
                e.preventDefault(); // Stop scrolling on touch
                const pos = this.getPos(e);
                
                const ctx = this.canvasContext;
                ctx.beginPath();
                ctx.moveTo(this.lastX, this.lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                
                this.lastX = pos.x;
                this.lastY = pos.y;
            },

            stopDrawing: function() {
                this.isDrawing = false;
            },

            getPos: function(e) {
                const rect = this.dom.canvas.getBoundingClientRect();
                let clientX = e.clientX;
                let clientY = e.clientY;
                
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }

                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            },

            revealDrawing: function() {
                this.dom.drawOverlay.classList.remove('opacity-0');
                this.dom.drawOverlay.classList.add('opacity-100');
                this.dom.btnReveal.classList.add('hidden');
                this.dom.drawActions.classList.remove('hidden');
                this.dom.drawActions.classList.add('grid');
            },

            gradeDrawing: function(correct) {
                if (correct) {
                    this.streak++;
                } else {
                    this.streak = 0;
                }
                this.updateStreak();
                this.nextDrawCard();
            },

            // --- QUIZ MODE ---
            nextQuizCard: function() {
                this.currentCard = this.getRandomCard();
                this.dom.quizQuestion.textContent = this.currentCard.char;
                
                // Generate Options
                const options = [this.currentCard];
                while(options.length < 4) {
                    const r = this.getRandomCard();
                    if (!options.find(o => o.char === r.char)) {
                        options.push(r);
                    }
                }
                // Shuffle
                options.sort(() => Math.random() - 0.5);

                // Render Buttons
                this.dom.quizOptions.innerHTML = '';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white border-2 border-slate-200 py-6 rounded-xl text-xl font-bold text-slate-700 hover:bg-slate-50 hover:border-blue-400 transition-all";
                    btn.textContent = opt.romaji;
                    btn.onclick = () => this.checkQuizAnswer(opt, btn);
                    this.dom.quizOptions.appendChild(btn);
                });
            },

            checkQuizAnswer: function(selected, btnElement) {
                const buttons = this.dom.quizOptions.querySelectorAll('button');
                buttons.forEach(b => b.disabled = true); // Disable all

                if (selected.char === this.currentCard.char) {
                    btnElement.classList.remove('border-slate-200', 'hover:border-blue-400');
                    btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                    this.streak++;
                    this.updateStreak();
                    setTimeout(() => this.nextQuizCard(), 600);
                } else {
                    btnElement.classList.remove('border-slate-200');
                    btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                    this.streak = 0;
                    this.updateStreak();
                    
                    // Highlight correct one
                    buttons.forEach(b => {
                        if (b.textContent === this.currentCard.romaji) {
                            b.classList.remove('border-slate-200');
                            b.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                        }
                    });

                    setTimeout(() => this.nextQuizCard(), 1500);
                }
            },

            // --- CHART MODE ---
            renderChart: function() {
                this.dom.chartGrid.innerHTML = '';
                KATAKANA_DATA.forEach(k => {
                    const div = document.createElement('div');
                    div.className = "flex flex-col items-center justify-center p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-red-200 hover:bg-red-50 transition-colors";
                    // Changed font-bold to font-medium for cleaner chart
                    div.innerHTML = `
                        <span class="text-2xl font-medium text-slate-800 jp-font">${k.char}</span>
                        <span class="text-xs text-slate-400 font-medium uppercase mt-1">${k.romaji}</span>
                    `;
                    this.dom.chartGrid.appendChild(div);
                });
            }
        };

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>